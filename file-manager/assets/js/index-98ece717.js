import{r as N,j as e,a as h,_ as s,s as L,F as $}from"./main.6.8.3.js";import{r as v}from"./react-vendor-0bea0611.js";import{a as q,u as V,c as Q}from"./@tanstack/react-query-cb8e8166.js";import{c as y,e as W,m as l,S as x,i as g,o as F,B as M,M as G,n as T,T as j,p as k,q as O,r as K,P as Y,D as H}from"./antd-b03f4406.js";import"./@emotion/react-f59bf8e1.js";import"./react-router-dom-551725bc.js";import"./@tanstack/react-query-devtools-28f31d30.js";function J(){const{mutateAsync:t,isLoading:c,variables:i}=q(async a=>N({action:"permissions/user/delete",data:{id:a}}));return{deletePermission:a=>t(a),isUserPermissionDeleting:c,delInProgressId:i}}function B(){const{data:t,isLoading:c,isFetching:i,refetch:a}=V({refetchOnWindowFocus:!1,staleTime:12e4,queryKey:["fetch_permissions_settings"],queryFn:async()=>N({action:"permissions/get",method:"GET"})});return{isLoading:c,isFetching:i,refetch:a,permissions:t==null?void 0:t.data.permissions,roles:t==null?void 0:t.data.roles,users:t==null?void 0:t.data.users,commands:(t==null?void 0:t.data.commands)||[],fileTypes:t==null?void 0:t.data.fileTypes,wpRoot:t==null?void 0:t.data.wpRoot}}function X(){const{mutateAsync:t,isLoading:c}=q(async i=>N({action:"permissions/update",data:i}));return{updatePermission:i=>t(i),isPermissionUpdating:c}}function Z(t,c){const[i,a]=v.useState(t);return v.useEffect(()=>{const p=setTimeout(()=>a(t),c||500);return()=>{clearTimeout(p)}},[t,c]),i}function ee(t){var b,E;async function c({pageParam:u=1,signal:P}){return(await N({action:"permissions/user/get",method:"GET",queryParam:{search:t,page:u},signal:P})).data}const{data:i,isLoading:a,fetchNextPage:p,hasNextPage:I,isFetching:S,isFetchingNextPage:w}=Q({refetchOnWindowFocus:!1,queryKey:["permissions/user/get",t],queryFn:c,keepPreviousData:!0,getNextPageParam:u=>{const P=Number(u.current)+1;return P<=u.pages?P:void 0}}),_=[];return i==null||i.pages.forEach(u=>_.push(...u.users)),{isLoading:a,fetchNextPage:p,hasNextPage:I,isFetching:S,isFetchingNextPage:w,users:_,total:((b=i==null?void 0:i.pages[0])==null?void 0:b.total)||0,totalPages:((E=i==null?void 0:i.pages[0])==null?void 0:E.pages)||0}}function se(){const{mutateAsync:t,isLoading:c}=q(async i=>N({action:"permissions/user/add",data:i}));return{updateUserPermission:i=>t(i),isUserPermissionUpdating:c}}function te({isModalOpen:t,setIsModalOpen:c,commands:i}){const{refetch:a}=B(),{isUserPermissionUpdating:p,updateUserPermission:I}=se(),[S,w]=v.useState(""),_=Z(S),{users:b,fetchNextPage:E,isFetching:u,isFetchingNextPage:P}=ee(_),{useForm:R}=l,[f]=R(),[m,z]=v.useState({}),A=o=>{w(o)},r=()=>{u&&P||E()},n=(o,d)=>{var U;d!=null&&d.user&&(z(d==null?void 0:d.user),f.resetFields(),f.setFieldValue("id",(U=d==null?void 0:d.user)==null?void 0:U.id))},C=o=>{I(o).then(d=>{if(d.code==="SUCCESS"){T.success({message:(d==null?void 0:d.message)??s("User permission deleted")}),a();const U=f.getFieldsError().map(D=>(D.errors&&(D.errors=[]),D));f.setFields(U)}else{const U=[];Object.keys(d.data).forEach(D=>{U.push({name:D.split("."),errors:d.data[D]}),T.error({message:(d==null?void 0:d.message)??s("Failed to save permission")})}),f.setFields(U)}})};return e(G,{open:t,onClose:()=>c(!1),onCancel:()=>c(!1),centered:!0,footer:!1,title:"Set Permission for selected user",children:h(x,{direction:"vertical",style:{display:"flex"},className:"px-2",children:[e(y,{showSearch:!0,style:{width:"100%"},placeholder:"Search User",onSearch:A,onChange:n,loading:u,notFoundContent:u?e(W,{size:"small"}):"No users found",filterOption:!1,options:b.map(o=>({value:o.ID,user:o,label:o.display_name})),allowClear:!0,onPopupScroll:r}),(m==null?void 0:m.display_name)&&e(l,{form:f,onFinish:C,disabled:p,colon:!1,scrollToFirstError:!0,children:e(x,{direction:"vertical",size:"middle",style:{display:"flex"},className:"px-2",children:h(g,{title:m.display_name,children:[e(l.Item,{name:"id",initialValue:m.ID,hidden:!0,children:e(F,{})}),e(l.Item,{name:"path",label:s("Path"),children:e(F,{placeholder:"Root Folder Path"})}),e(l.Item,{name:"commands",label:s("Enabled Commands"),children:e(y,{mode:"multiple",children:i==null?void 0:i.map(o=>e(y.Option,{value:o,children:o},o))})}),e(l.Item,{style:{marginBottom:0},children:e(M,{type:"primary",htmlType:"submit",loading:p,children:"Save"})})]},`permissions-for-${m.ID}`)})})]})})}function ce(){const{useForm:t}=l,{isLoading:c,permissions:i,commands:a,fileTypes:p,roles:I,users:S,refetch:w}=B(),{updatePermission:_,isPermissionUpdating:b}=X(),{deletePermission:E,isUserPermissionDeleting:u,delInProgressId:P}=J(),[R,f]=v.useState(!1),[m]=t();v.useEffect(()=>{m.setFieldsValue(i)},[i,m]);const z=r=>{_(r).then(n=>{if(n.code==="SUCCESS"){T.success({message:n.message});const C=m.getFieldsError().map(o=>(o.errors&&(o.errors=[]),o));m.setFields(C)}else{const C=[];Object.keys(n.data).forEach(o=>{C.push({name:o.split("."),errors:n.data[o]}),T.error({message:(n==null?void 0:n.message)??s("Failed to update permission")})}),m.setFields(C)}})},A=r=>{E(r.ID).then(n=>{n.code==="SUCCESS"?(T.success({message:(n==null?void 0:n.message)??s("User permission removed")}),w()):T.error({message:(n==null?void 0:n.message)??s("Failed to remove permission")})})};return h($,{children:[e(g,{title:s("File Manager Shortcode"),style:{marginInline:"0.625rem"},children:e(j.Text,{copyable:{text:"[file-manager]"},children:"[file-manager]"})}),e(l,{form:m,onFinish:z,disabled:c||b,initialValues:i,colon:!1,scrollToFirstError:!0,children:h(x,{direction:"vertical",size:"middle",style:{display:"flex"},className:"px-2",children:[e(x,{style:{display:"flex",justifyContent:"right",paddingBlock:"8px"},children:e(l.Item,{style:{marginBottom:0},children:e(M,{type:"primary",htmlType:"submit",loading:b,children:s("Update")})})}),h(g,{children:[e(l.Item,{name:"do_not_use_for_admin",label:s("Disable this permission inside WordPress dashboard"),tooltip:s("When this option is enabled, the File Manager within the WordPress dashboard will operate independently of the permission settings configured for users and user roles."),children:e(k,{})}),e(l.Item,{name:"fileType",label:s("Allowed MIME types"),tooltip:s("Enable only the MIME types you need. Allowing unnecessary types may pose security risks."),children:e(y,{mode:"multiple",children:p==null?void 0:p.map(r=>e(y.Option,{value:r,children:r},r))})}),e(l.Item,{name:"file_size",label:"Max upload Size",children:e(F,{type:"number",placeholder:s("Maximum File Size"),addonAfter:"MB"})})]}),h(g,{title:s("Public folder options"),children:[e(l.Item,{name:"root_folder",children:e(F,{placeholder:s("Root Folder Path")})}),e(l.Item,{name:"root_folder_url",children:e(F,{placeholder:s("Root Folder URL")})}),e(l.Item,{name:"folder_options",label:s("Folder Options"),children:h(O.Group,{size:"large",children:[e(O,{value:"common",children:s("Enable a common folder for everyone")}),e(O,{value:"user",children:s("Enable separate folders for each user")}),e(O,{value:"role",children:s("Enable folders for each user role")})]})})]}),e(g,{title:s("Permissions by Roles"),children:e(x,{size:20,wrap:!0,children:I==null?void 0:I.map(r=>h(g,{title:r.toUpperCase(),children:[e(l.Item,{name:["by_role",r,"path"],label:s("Path"),children:e(F,{placeholder:s("Root Folder Path")})}),e(l.Item,{name:["by_role",r,"commands"],label:s("Enabled Commands"),children:e(y,{mode:"multiple",children:a==null?void 0:a.map(n=>e(y.Option,{value:n,children:n},n))})})]},`permissions-for-${r}`))})}),e(g,{title:s("Permissions by User"),extra:e(K,{title:`${s("Add permission for a user")}`,children:e(M,{type:"dashed",htmlType:"button",onClick:()=>f(!0),children:"+"})}),children:h(x,{size:20,wrap:!0,children:[e(te,{isModalOpen:R,setIsModalOpen:f,commands:a}),S==null?void 0:S.map(r=>h(g,{title:r.display_name,extra:e(Y,{title:s("Delete the User Permission"),description:e(j.Text,{children:s(L("Are you sure to delete permission for %s?",`${r.display_name}${r.user_login!==r.display_name?`(${r.user_login})`:""}`))}),onConfirm:()=>A(r),okText:"Yes",cancelText:"No",children:e(M,{loading:u&&P===r.ID,children:e(H,{})})}),children:[e(l.Item,{name:["by_user",r.ID,"path"],label:s("Path"),children:e(F,{placeholder:s("Root Folder Path")})}),e(l.Item,{name:["by_user",r.ID,"commands"],label:s("Enabled Commands"),children:e(y,{mode:"multiple",children:a==null?void 0:a.map(n=>e(y.Option,{value:n,children:n},n))})})]},`permissions-for-${r.ID}`))]})}),h(g,{title:s("Guest User Settings"),children:[e(l.Item,{name:["guest","path"],label:s("Path"),children:e(F,{placeholder:s("Root Folder Path")})}),e(l.Item,{name:["guest","can_download"],label:s("can download?"),children:e(k,{})})]}),e(l.Item,{children:e(x,{style:{display:"flex",justifyContent:"center"},children:e(l.Item,{children:e(M,{type:"primary",htmlType:"submit",loading:b,children:"Update"})})})})]})})]})}export{ce as default};
