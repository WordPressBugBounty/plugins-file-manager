import{r as R,j as e,a as h,_ as l,s as $,F as k}from"./main.6.6.2.js";import{r as v}from"./react-vendor-0bea0611.js";import{a as A,u as V,c as Q}from"./@tanstack/react-query-cb8e8166.js";import{c as y,e as G,m as n,S as x,i as g,o as F,B as N,M as W,n as T,T as j,p as B,q as O,r as K,P as Y,D as H}from"./antd-b03f4406.js";import"./@emotion/react-f59bf8e1.js";import"./react-router-dom-9a9ab4e4.js";import"./@tanstack/react-query-devtools-28f31d30.js";function J(){const{mutateAsync:s,isLoading:c,variables:t}=A(async a=>R({action:"permissions/user/delete",data:{id:a}}));return{deletePermission:a=>s(a),isUserPermissionDeleting:c,delInProgressId:t}}function L(){const{data:s,isLoading:c,isFetching:t,refetch:a}=V({refetchOnWindowFocus:!1,staleTime:12e4,queryKey:["fetch_permissions_settings"],queryFn:async()=>R({action:"permissions/get",method:"GET"})});return{isLoading:c,isFetching:t,refetch:a,permissions:s==null?void 0:s.data.permissions,roles:s==null?void 0:s.data.roles,users:s==null?void 0:s.data.users,commands:(s==null?void 0:s.data.commands)||[],fileTypes:s==null?void 0:s.data.fileTypes,wpRoot:s==null?void 0:s.data.wpRoot}}function X(){const{mutateAsync:s,isLoading:c}=A(async t=>R({action:"permissions/update",data:t}));return{updatePermission:t=>s(t),isPermissionUpdating:c}}function Z(s,c){const[t,a]=v.useState(s);return v.useEffect(()=>{const p=setTimeout(()=>a(s),c||500);return()=>{clearTimeout(p)}},[s,c]),t}function ee(s){var b,E;async function c({pageParam:u=1,signal:P}){return(await R({action:"permissions/user/get",method:"GET",queryParam:{search:s,page:u},signal:P})).data}const{data:t,isLoading:a,fetchNextPage:p,hasNextPage:I,isFetching:S,isFetchingNextPage:w}=Q({refetchOnWindowFocus:!1,queryKey:["permissions/user/get",s],queryFn:c,keepPreviousData:!0,getNextPageParam:u=>{const P=Number(u.current)+1;return P<=u.pages?P:void 0}}),_=[];return t==null||t.pages.forEach(u=>_.push(...u.users)),{isLoading:a,fetchNextPage:p,hasNextPage:I,isFetching:S,isFetchingNextPage:w,users:_,total:((b=t==null?void 0:t.pages[0])==null?void 0:b.total)||0,totalPages:((E=t==null?void 0:t.pages[0])==null?void 0:E.pages)||0}}function se(){const{mutateAsync:s,isLoading:c}=A(async t=>R({action:"permissions/user/add",data:t}));return{updateUserPermission:t=>s(t),isUserPermissionUpdating:c}}function te({isModalOpen:s,setIsModalOpen:c,commands:t}){const{refetch:a}=L(),{isUserPermissionUpdating:p,updateUserPermission:I}=se(),[S,w]=v.useState(""),_=Z(S),{users:b,fetchNextPage:E,isFetching:u,isFetchingNextPage:P}=ee(_),{useForm:M}=n,[f]=M(),[m,z]=v.useState({}),q=o=>{w(o)},i=()=>{u&&P||E()},r=(o,d)=>{var U;d!=null&&d.user&&(z(d==null?void 0:d.user),f.resetFields(),f.setFieldValue("id",(U=d==null?void 0:d.user)==null?void 0:U.id))},C=o=>{I(o).then(d=>{if(d.code==="SUCCESS"){T.success({message:(d==null?void 0:d.message)??l("User permission deleted")}),a();const U=f.getFieldsError().map(D=>(D.errors&&(D.errors=[]),D));f.setFields(U)}else{const U=[];Object.keys(d.data).forEach(D=>{U.push({name:D.split("."),errors:d.data[D]}),T.error({message:(d==null?void 0:d.message)??l("Failed to save permission")})}),f.setFields(U)}})};return e(W,{open:s,onClose:()=>c(!1),onCancel:()=>c(!1),centered:!0,footer:!1,title:"Set Permission for selected user",children:h(x,{direction:"vertical",style:{display:"flex"},className:"px-2",children:[e(y,{showSearch:!0,style:{width:"100%"},placeholder:"Search User",onSearch:q,onChange:r,loading:u,notFoundContent:u?e(G,{size:"small"}):"No users found",filterOption:!1,options:b.map(o=>({value:o.ID,user:o,label:o.display_name})),allowClear:!0,onPopupScroll:i}),(m==null?void 0:m.display_name)&&e(n,{form:f,onFinish:C,disabled:p,colon:!1,scrollToFirstError:!0,children:e(x,{direction:"vertical",size:"middle",style:{display:"flex"},className:"px-2",children:h(g,{title:m.display_name,children:[e(n.Item,{name:"id",initialValue:m.ID,hidden:!0,children:e(F,{})}),e(n.Item,{name:"path",label:l("Path"),children:e(F,{placeholder:"Root Folder Path"})}),e(n.Item,{name:"commands",label:l("Enabled Commands"),children:e(y,{mode:"multiple",children:t==null?void 0:t.map(o=>e(y.Option,{value:o,children:o},o))})}),e(n.Item,{style:{marginBottom:0},children:e(N,{type:"primary",htmlType:"submit",loading:p,children:"Save"})})]},`permissions-for-${m.ID}`)})})]})})}function ce(){const{useForm:s}=n,{isLoading:c,permissions:t,commands:a,fileTypes:p,roles:I,users:S,refetch:w}=L(),{updatePermission:_,isPermissionUpdating:b}=X(),{deletePermission:E,isUserPermissionDeleting:u,delInProgressId:P}=J(),[M,f]=v.useState(!1),[m]=s();v.useEffect(()=>{m.setFieldsValue(t)},[t,m]);const z=i=>{_(i).then(r=>{if(r.code==="SUCCESS"){T.success({message:r.message});const C=m.getFieldsError().map(o=>(o.errors&&(o.errors=[]),o));m.setFields(C)}else{const C=[];Object.keys(r.data).forEach(o=>{C.push({name:o.split("."),errors:r.data[o]}),T.error({message:(r==null?void 0:r.message)??l("Failed to update permission")})}),m.setFields(C)}})},q=i=>{E(i.ID).then(r=>{r.code==="SUCCESS"?(T.success({message:(r==null?void 0:r.message)??l("User permission removed")}),w()):T.error({message:(r==null?void 0:r.message)??l("Failed to remove permission")})})};return h(k,{children:[e(g,{title:"File Manager Shortcode",style:{marginInline:"0.625rem"},children:e(j.Text,{copyable:{text:"[file-manager]"},children:"[file-manager]"})}),e(n,{form:m,onFinish:z,disabled:c||b,initialValues:t,colon:!1,scrollToFirstError:!0,children:h(x,{direction:"vertical",size:"middle",style:{display:"flex"},className:"px-2",children:[e(x,{style:{display:"flex",justifyContent:"right",paddingBlock:"8px"},children:e(n.Item,{style:{marginBottom:0},children:e(N,{type:"primary",htmlType:"submit",loading:b,children:"Update"})})}),h(g,{children:[e(n.Item,{name:"do_not_use_for_admin",label:l("Disable this permission inside WordPress dashboard"),tooltip:l("If disabled, the root folder for the file manager will be determined by this permission setting."),children:e(B,{})}),e(n.Item,{name:"fileType",label:"Allowed MIME types",children:e(y,{mode:"multiple",children:p==null?void 0:p.map(i=>e(y.Option,{value:i,children:i},i))})}),e(n.Item,{name:"file_size",label:"Max upload Size",children:e(F,{type:"number",placeholder:"Maximum File Size",addonAfter:"MB"})})]}),h(g,{title:l("Public folder options"),children:[e(n.Item,{name:"root_folder",children:e(F,{placeholder:"Root Folder Path"})}),e(n.Item,{name:"root_folder_url",children:e(F,{placeholder:"Root Folder URL"})}),e(n.Item,{name:"folder_options",label:l("Folder Options"),children:h(O.Group,{size:"large",children:[e(O,{value:"common",children:"Enable a common folder for everyone"}),e(O,{value:"user",children:"Enable separate folders for each user"}),e(O,{value:"role",children:"Enable folders for each user role"})]})})]}),e(g,{title:l("Permissions by Roles"),children:e(x,{size:20,wrap:!0,children:I==null?void 0:I.map(i=>h(g,{title:i.toUpperCase(),children:[e(n.Item,{name:["by_role",i,"path"],label:l("Path"),children:e(F,{placeholder:"Root Folder Path"})}),e(n.Item,{name:["by_role",i,"commands"],label:l("Enabled Commands"),children:e(y,{mode:"multiple",children:a==null?void 0:a.map(r=>e(y.Option,{value:r,children:r},r))})})]},`permissions-for-${i}`))})}),e(g,{title:l("Permissions by User"),extra:e(K,{title:`${l("Add permission for a user")}`,children:e(N,{type:"dashed",htmlType:"button",onClick:()=>f(!0),children:"+"})}),children:h(x,{size:20,wrap:!0,children:[e(te,{isModalOpen:M,setIsModalOpen:f,commands:a}),S==null?void 0:S.map(i=>h(g,{title:i.display_name,extra:e(Y,{title:l("Delete the User Permission"),description:e(j.Text,{children:l($("Are you sure to delete permission for %s?",`${i.display_name}${i.user_login!==i.display_name?`(${i.user_login})`:""}`))}),onConfirm:()=>q(i),okText:"Yes",cancelText:"No",children:e(N,{loading:u&&P===i.ID,children:e(H,{})})}),children:[e(n.Item,{name:["by_user",i.ID,"path"],label:l("Path"),children:e(F,{placeholder:"Root Folder Path"})}),e(n.Item,{name:["by_user",i.ID,"commands"],label:l("Enabled Commands"),children:e(y,{mode:"multiple",children:a==null?void 0:a.map(r=>e(y.Option,{value:r,children:r},r))})})]},`permissions-for-${i.ID}`))]})}),h(g,{title:l("Guest User Settings"),children:[e(n.Item,{name:["guest","path"],label:l("Path"),children:e(F,{placeholder:"Root Folder Path"})}),e(n.Item,{name:["guest","can_download"],label:l("can download?"),children:e(B,{})})]}),e(n.Item,{children:e(x,{style:{display:"flex",justifyContent:"center"},children:e(n.Item,{children:e(N,{type:"primary",htmlType:"submit",loading:b,children:"Update"})})})})]})})]})}export{ce as default};
